<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Redis Durability | Ilias Lolis&#x27; Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.lolis.gr/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.lolis.gr/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.lolis.gr/redis-durability"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Redis Durability | Ilias Lolis&#x27; Blog"><meta data-rh="true" name="description" content="Redis Fundamentals"><meta data-rh="true" property="og:description" content="Redis Fundamentals"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-04-27T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ilolis"><meta data-rh="true" property="article:tag" content="durability,microservices,redis,replication"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://blog.lolis.gr/redis-durability"><link data-rh="true" rel="alternate" href="https://blog.lolis.gr/redis-durability" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.lolis.gr/redis-durability" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Ilias Lolis&#39; Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Ilias Lolis&#39; Blog Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8EF06WYGTZ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8EF06WYGTZ",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.9e333529.css">
<link rel="preload" href="/assets/js/runtime~main.71bad8c0.js" as="script">
<link rel="preload" href="/assets/js/main.bd3cce5c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Articles</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ilolis/my-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/redis-durability">Redis Durability</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/welcome-to-my-blog">Welcome To My Blog</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Redis Durability</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-04-27T00:00:00.000Z" itemprop="datePublished">April 27, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ilolis" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ilolis.png" alt="Ilias Lolis"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ilolis" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Ilias Lolis</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-fundamentals">Redis Fundamentals<a href="#redis-fundamentals" class="hash-link" aria-label="Direct link to Redis Fundamentals" title="Direct link to Redis Fundamentals">​</a></h3><p>Redis is a high-performance, distributed, in-memory data store that can be used as a database, cache or message broker. It is an open-source, NoSQL database that is designed to deliver high performance and low latency access to data. The core difference between Redis and a traditional database such as Postgres, MySQL and DynamoDB is that Redis stores data in memory and not in disk, a <em>feature</em> that gives Redis ultra fast response times.</p><p>However, the approach of storing data in-memory can be prone to data loss in the event of a system crash or power failure. In contrast, storing data persistently on disk provides durability, but at the cost of slower access times due to disk I/O. In this article, we will discuss methods for configuring Redis to be more resilient, as an out-of-the-box configuration of Redis could result in complete data loss if your Redis instance crashes.</p><p>There exist several methods to safeguard against a data loss. However, it is commonly misunderstood that enabling replication in Redis suffices to solve this problem. Yet, this notion does not always hold true. Prior to exploring the various options available for ensuring the durability of Redis as a database, let&#x27;s first examine how Redis replication works.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-replication">Redis Replication<a href="#redis-replication" class="hash-link" aria-label="Direct link to Redis Replication" title="Direct link to Redis Replication">​</a></h3><p>Redis provides a replication mechanism that allows it to withstand a node failure increasing the availability and the throughput of the system. The default replication strategy of Redis is based on a master-replica model, where one Redis instance acts as the master and one or more Redis instances act as replicas. The master continuously sends commands and data to its replicas, which replicate the master&#x27;s data in near real-time. When a write operation occurs on the master, the operation is first written to the master&#x27;s in-memory database, acknowledged to the client and then transmitted <strong>asynchronously</strong> to all the connected replicas. The replicas then execute the same operation in their own databases, which allows them to maintain a copy of the master&#x27;s data and being in-sync. </p><p>In case of a master node failure, Redis supports automatic failover, where a replica can be promoted to a master. Redis achieves this by monitoring the health of the master and by initiating a failover if necessary. When Redis detects that the master is down, it selects one replica to promote to master and reconfigures the other replicas to replicate from the new master. This process is designed to be automatic and fast, allowing for minimal downtime in the event of a master failure.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-catch">The catch<a href="#the-catch" class="hash-link" aria-label="Direct link to The catch" title="Direct link to The catch">​</a></h4><p>The catch in the above strategy is the fact that the replication of the data between the master and the replica happens asynchronously. This means that when a client issues a write command to a Redis master, the master will acknowledge the write operation and then asynchronously update the replicas. If the master crashes after sending the acknowledgement to the client but <strong>before</strong> sending the write command to the replicas, the failover mechanism will be triggered and a slave will be promoted to a master, <strong>without</strong> including the latest write command!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-mitigate">How to mitigate<a href="#how-to-mitigate" class="hash-link" aria-label="Direct link to How to mitigate" title="Direct link to How to mitigate">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-1-use-wait-n-t">Option 1: Use <code>WAIT N T</code><a href="#option-1-use-wait-n-t" class="hash-link" aria-label="Direct link to option-1-use-wait-n-t" title="Direct link to option-1-use-wait-n-t">​</a></h4><p>The <code>WAIT N T</code> command instructs the master to replicate the write request to at least <code>N</code> replicas and for a maximum of <code>T</code> milliseconds before acknowledging the write request to the client. </p><p>In this scenario, if <code>N</code> equals to the number of replicas, then the write operation will only be considered complete when all replicas have received the write and acknowledged it. This approach ensures that all replicas get the write command and in case of a failover all of the replicas will be in-sync with the master, so that no-data will be lost.</p><p>If the N parameter in the <code>WAIT</code> command is set to a value less than the total number of replicas, then the write operation will only be applied to <code>N</code> replicas, and not all replicas in the system will have the latest write. If a replica that did not receive the latest write is promoted to a master during a failover the latest write will be lost. Therefore, it&#x27;s important to set the <code>N</code> parameter to a value that is equal to the number of replicas to ensure that all replicas receive the latest write and to prevent data loss.</p><p>However, it&#x27;s important to note that this approach comes with a significant performance  trade-off. Waiting for all your replicas to acknowledge a write operation can result in increased latency and reduced throughput, especially when your application is read-heavy requiring many replicas. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-2-make-redis-a-persistence-database">Option 2: Make Redis a persistence database<a href="#option-2-make-redis-a-persistence-database" class="hash-link" aria-label="Direct link to Option 2: Make Redis a persistence database" title="Direct link to Option 2: Make Redis a persistence database">​</a></h4><p>Since Redis stores all of your data in-memory, you should be aware that in the above solution, if the master and all of the replicas fail due to hardware issues, you will lose your data permanently. To make your Redis durable, you can configure Redis to dump your data to durable storage such as an SSD or an HDD. </p><p>Redis provides two mechanisms for persistence: RDB (Redis Database) and AOF (Append Only File). RDB persistence is a point-in-time snapshot of the entire Redis dataset. It works by periodically saving the dataset to disk as a binary file. This binary file can be used to restore the dataset in case of a Redis restart. RDB persistence is suitable for scenarios where you can afford to lose some data since the persistence is performed at a specific interval (for example every <code>n</code> seconds). This method does not cause any significant response latency for the write commands, since saving the dataset to the disk happens asynchronously, but it does not guarantee that the dumped dataset will contain all of the write operations. </p><p>AOF persistence, on the other hand, logs all the write operations to a file. The AOF file contains a sequence of write operations that can be replayed to reconstruct the dataset. AOF persistence is suitable for scenarios where you cannot afford to lose any data, as it logs every write operation before acknowledging it to the client. </p><p>Although writing your dataset to disk provides protection in the event of Redis failure, it also has a significant disadvantage: increased latency and reduced throughput. However, it&#x27;s important to keep in mind that Redis is primarily an in-memory database, so enabling the AOF (Append-Only File) functionality may seem counter-intuitive. <strong>If durability is a top priority, consider using an on-disk database such as DynamoDB or MongoDB instead.</strong> These databases are optimized for durability and can provide more comprehensive data protection.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-correctly-mitigate-in-aws">How to correctly mitigate in AWS<a href="#how-to-correctly-mitigate-in-aws" class="hash-link" aria-label="Direct link to How to correctly mitigate in AWS" title="Direct link to How to correctly mitigate in AWS">​</a></h3><p>By implementing the AOF feature in Redis, all writes are stored on disk, ensuring durability. Meanwhile, subsequent reads are retrieved from memory, resulting in faster read speeds compared to traditional on-disk databases. However, write operations are still as slow as on-disk database systems.</p><p>By now, you should be familiar that making Redis a durable database might raise some eyebrows, especially when you have <em>great</em> alternatives to choose from. For example, DynamoDB provides durability out-of-the-box and has a cool feature named DynamoDB Accelerator (DAX). DAX is a fully managed, in-memory cache layer that sits between your application and DynamoDB, making your read operations as fast as what Redis can deliver!</p><p>If I haven&#x27;t yet convinced you to not make Redis a durable database, then let&#x27;s discuss how you can achieve that in AWS. AWS does not let you enable the AOF feature if you have Multi-AZ deployment, so you are out of luck. Thankfully, a different service called AWS MemoryDB solves this problem. AWS markets MemoryDB as a &quot;Redis-compatible, durable, in-memory database service for ultra-fast performance&quot; that &quot;stores data durably across multiple Availability Zones (AZs) <strong>using a distributed transactional log</strong> <!-- -->[emphasis mine]<!-- --> to enable fast failover, database recovery, and node restarts&quot;.  </p><p>MemoryDB achieves durability by enabling the AOF feature we discussed earlier. The Append-Only-File is distributed across different Availability Zones which ensures that your data isn&#x27;t lost, even if an AZ becomes offline. In the event where all of your Redis instances fail, MemoryDB will create new instances and restore all the data from the previous instances by executing the AOF. Moreover, in the scenario that only the master node fails and an out-of-date replica is promoted to master, MemoryDB will detect that the new master does not contain all of the data and trigger an execution of the AOF on the new master to prevent any data loss!</p><p>The bad case about MemoryDB is that it is very expensive. At the time of writing, the price of <code>db.r6g.large</code> with on-demand pricing for the Ireland region costs $0.344/hour which totals to about $260/month. The same instance in ElastiCache costs only about $170/month, which is significantly cheaper. Moreover, MemoryDB changes $0.20 for each GB of data you write to your Redis, which isn&#x27;t significant, but if your application is write-heavy, then this cost will add up quickly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In conclusion, Redis is a powerful and flexible in-memory data store that can be used for a wide range of use cases such as caching and message queuing. However, the in-memory approach that Redis uses for storage can be prone to data loss in the event of a system failure or power outage. <strong>This means that keys and <a href="https://redis.io/docs/data-types/streams-tutorial/" target="_blank" rel="noopener noreferrer">stream items</a> might be lost if your master experiences a failure! Don&#x27;t choose Redis if you can&#x27;t afford to loose any data!</strong> </p><p>To mitigate the above problem, Redis provides replication and persistence. Replication provides a mechanism for failover and high availability, but it comes with the risk of lost data if all of your nodes fail simultaneously. On the other hand, persistence options such as RDB and AOF provide more durable storage by saving data to disk. The choice between these options will depend on the specific needs and requirements of your application.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/durability">durability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/microservices">microservices</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/replication">replication</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ilolis/my-blog/tree/main/blog/2023-04-27-redis-durability.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/welcome-to-my-blog"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Welcome To My Blog</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#redis-fundamentals" class="table-of-contents__link toc-highlight">Redis Fundamentals</a></li><li><a href="#redis-replication" class="table-of-contents__link toc-highlight">Redis Replication</a></li><li><a href="#how-to-mitigate" class="table-of-contents__link toc-highlight">How to mitigate</a></li><li><a href="#how-to-correctly-mitigate-in-aws" class="table-of-contents__link toc-highlight">How to correctly mitigate in AWS</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Ilias Lolis. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.71bad8c0.js"></script>
<script src="/assets/js/main.bd3cce5c.js"></script>
</body>
</html>